---
- hosts: dov
  remote_user: root
  vars_prompt:
    - name: "username"
      prompt: "Enter the username you want to add"
      private: no
    - name: "password"
      prompt: "Enter the password for the user"
      private: yes
    - name: "UID"
      prompt: "Give the user an UID"
      private: no 

  tasks:
  - name: create newuser.ldif
    shell: |
        echo "# This file is generated by ansible.
        dn: uid={{ username }},ou=People,dc=ldapserver,dc=com
        objectClass: top
        objectClass: account
        objectClass: postfixUser
        objectClass: posixAccount
        objectClass: shadowAccount
        cn: {{ username }}
        uid: {{ username }}
        uidNumber: {{ UID }}
        gidNumber: 12
        homeDirectory: /home/shared/{{ username }}
        loginShell: /sbin/nologin
        gecos: One user of mail service
        userPassword: {{ password }}
        mailacceptinggeneralid: {{ username }}
        maildrop: {{ username }}
        " > /root/ldif/newuser.ldif

  - name: add newuser to LDAP
    expect:
      command: ldapadd -x -W -D "cn=ldapadm,dc=ldapserver,dc=com" -f /root/ldif/newuser.ldif
      responses:
        Enter LDAP Password: "nasa2017sa5"
