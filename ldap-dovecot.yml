---
- hosts: dov
  remote_user: root
  tasks:
  - name: install packages for LDAP client
    yum:
      name: openldap,compat-openldap,openldap-clients,openldap-servers,openldap-servers-sql,openldap-devel,pam,pam-devel,pam_ldap,nss-pam-ldapd

  - name: modify dovecot configuration
    lineinfile:
      path: /etc/dovecot/conf.d/10-auth.conf
      regexp: "include auth-ldap.conf.ext"
      line: "!include auth-ldap.conf.ext"

  - name: create auth-ldap.conf for dovecot
    shell: |
        echo "# This file is generated by ansible.
        passdb {
          driver = ldap
          args = /etc/dovecot/dovecot-ldap.conf
        }
        
        userdb {
          driver = ldap
          args = /etc/dovecot/dovecot-ldap.conf
        }
        " > /etc/dovecot/conf.d/auth-ldap.conf.ext

  - name: create dovecot-ldap for dovecot
    shell: |
        echo "# This file is generated by ansible.
        hosts = localhost:389
        dn = cn=ldapadm,dc=ldapserver,dc=com
        dnpass = nasa2017sa5
        base = cn=ldapadm,dc=ldapserver,dc=com
        " > /etc/dovecot/dovecot-ldap.conf

  - name: update server auth setting
    command: authconfig --enableldap --enableldapauth --ldapserver=localhost --ldapbasedn="dc=ldapserver,dc=com" --enablemkhomedir --update
